<!DOCTYPE html>
<html>
    <head>
        <title>Edit: {{ page_name }}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
    </head>
    
<body>
    <h2>Editing: {{ page_name }}</h2>

    <div id="workspace" style="width: 100%; height: 80vh; border: 1px dashed gray; position: relative;"></div>


    <!-- these buttons must be OUTSIDE workspace! -->
<div class="bottom-buttons">
    <button onclick="addBoxTriggerBox()">üì¶ Add Trigger Box</button>
    <button onclick="addButton()">‚ûï Add Button</button>
    <button onclick="addUploadBox()">üì§ Upload File to Table</button>
    <button onclick="addMultiUploadBox()">üì§ Upload Multi Files</button>
    <button onclick="addDownloadBox()">üì• Download Table to File</button>
    <button onclick="addFormBox()">üìù Add Form Box</button>
    <button onclick="addMiniAnalytics()">üìä Add Mini Analytics</button>
    <button onclick="addSmartTableBox()">üìã Add Smart Table</button>
    <button onclick="addAIBox()">ü§ñ Add AI Chat</button>
    <button onclick="saveLayout()">üíæ Save</button>
    <a href="{{ url_for('developer.developer_dashboard') }}">
        <button>‚¨ÖÔ∏è Back to Developer Dashboard</button>
    </a>
</div>

    <script>
        let dragged = null, offsetX = 0, offsetY = 0;
        let dragTimeout = null;
        let isDragging = false;

        document.addEventListener('mousedown', e => {
            const box = e.target.closest('.button-box');
        
            // ‚ùå Ignore drag if clicking inside input/textarea/select
            const isFormControl = ['TEXTAREA', 'INPUT', 'SELECT'].includes(e.target.tagName);
            if (box && !isFormControl) {
                offsetX = e.offsetX;
                offsetY = e.offsetY;
        
                dragTimeout = setTimeout(() => {
                    dragged = box;
                    isDragging = true;
                }, 500); // 0.5s is fine now ‚Äî won't trigger on typing/resizing
            }
        });
        
        
        document.addEventListener('mousemove', e => {
    if (isDragging && dragged) {
        const gridSize = 20;
        const newLeft = Math.round((e.pageX - offsetX) / gridSize) * gridSize;
        const newTop = Math.round((e.pageY - offsetY) / gridSize) * gridSize;

        dragged.style.left = newLeft + 'px';
        dragged.style.top = newTop + 'px';

        // üü¢ ADD THIS BELOW moving the dragged box:
        const workspace = document.getElementById('workspace');
        const bottomEdge = dragged.offsetTop + dragged.offsetHeight;

        if (bottomEdge > workspace.offsetHeight - 60) {
            workspace.style.minHeight = (bottomEdge + 120) + 'px';
        }
    }
});
        
        document.addEventListener('mouseup', () => {
            clearTimeout(dragTimeout);
            if (isDragging) {
                dragged = null;
                isDragging = false;
            }
        });
        
    
        // üîÅ Handle type switch between code vs link
        function toggleActionInput(select) {
            const box = select.closest('.button-box');
            const linkSelect = box.querySelector('.page-link');
            const codeInput = box.querySelector('.code-input');
        
            if (select.value === 'link') {
                if (linkSelect) linkSelect.style.display = 'block';
                if (codeInput) codeInput.style.display = 'none';
            } else {
                if (linkSelect) linkSelect.style.display = 'none';
                if (codeInput) codeInput.style.display = 'block';
            }
        }

        function addAIBox() {
            const dbOptions = Object.keys(dbTables).map(db => `<option value="${db}">${db}</option>`).join('');

            const div = document.createElement('div');
            div.className = 'button-box';
            div.style.top = '50px';
            div.style.left = '50px';
            div.innerHTML = `
                <input type="text" class="btn-label" value="AI Chat Assistant"><br>

                <select class="type-selector" disabled>
                    <option value="ai_chat" selected>ü§ñ AI Chat</option>
                </select><br>

                <textarea class="ai-question" placeholder="Ask a question like 'filter only active policies'..."></textarea><br>

                <label>
                    File 1: <input type="file" class="ai-file-1">
                </label>
                <label>
                    File 2 (optional): <input type="file" class="ai-file-2">
                </label>

                <label>
                    Database:
                    <select class="db-select">
                        <option value="">-- None --</option>
                        ${dbOptions}
                    </select>
                </label>

                <label>Group Box:
                    <input type="text" class="group-id-input" placeholder="(optional)">
                </label><br>

                <label>Layout Mode:
                    <select class="layout-mode">
                        <option value="auto">üì¶ Stack Neatly</option>
                        <option value="absolute">üìç Manual Position</option>
                    </select>
                </label><br>


                <label>
                    <input type="checkbox" class="background-check"> Run in background
                </label>

                <button onclick="this.parentElement.remove()">‚ùå</button>
            `;

            document.getElementById('workspace').appendChild(div);

        }

        function addFormBox() {
    const dbOptions = Object.keys(dbTables).map(db => `<option value="${db}">${db}</option>`).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = '50px';
    div.style.left = '50px';
    div.innerHTML = `
        <input type="text" class="btn-label" value="Fix Missing Data"><br>

        <select class="type-selector" disabled>
            <option value="form" selected>üìù Form</option>
        </select><br>

        <label>Database:
            <select class="db-select" onchange="updateTablesAndColumns(this)">
                ${dbOptions}
            </select>
        </label><br>

        <label>Table:
            <select class="table-select" onchange="loadColumnsForTable(this)"></select>
        </label><br>

        <input type="hidden" class="key-column" value="system_id">

        <label>Filter Mode:
            <select class="filter-mode" onchange="toggleFilterInput(this)">
                <option value="simple" selected>Simple Filter</option>
                <option value="python">Python Code</option>
            </select>
        </label><br>

        <div class="simple-filter-section">
            <label>Simple SQL Filter:<input type="text" class="sql-filter" placeholder="e.g., policy_number IS NULL"></label><br>
        </div>

        <div class="python-filter-section" style="display:none;">
            <label>Python Filter Code:<br>
                <textarea class="python-filter-code" placeholder="e.g., df[df['column'].isna()]" style="width: 100%; height: 60px;"></textarea>
            </label><br>
        </div>

        <label>Editable Columns:<br>
            <div class="column-list" style="max-height: 100px; overflow-y: auto; border: 1px solid #ccc;"></div>
        </label><br>

        <hr>

        <label>üîé Lookup Database:
            <select class="lookup-db-select" onchange="updateLookupTables(this)">
                <option value="">-- None --</option>
                ${dbOptions}
            </select>
        </label><br>

        <label>Lookup Table:
            <select class="lookup-table-select" onchange="loadLookupColumns(this)">
                <option value="">-- None --</option>
            </select>
        </label><br>

        <label>Lookup Key Column:<input type="text" class="lookup-key-column" placeholder="Optional"></label><br>

        <label>Lookup Fields:<br>
            <div class="lookup-column-list" style="max-height: 100px; overflow-y: auto; border: 1px solid #ccc;">
                (select after table loaded)
            </div>
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto">üì¶ Stack Neatly</option>
                <option value="absolute">üìç Manual Position</option>
            </select>
        </label><br>

        <label>
            <input type="checkbox" class="background-check"> Run in background
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    document.getElementById('workspace').appendChild(div);

}

        let smartCellCode = {};
        let selectedSmartCell = "R1C1";

        function addSmartTableBox() {
    const dbOptions = Object.keys(dbTables).map(db => `<option value="${db}">${db}</option>`).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = '50px';
    div.style.left = '50px';

    div.innerHTML = `
        <input type="text" class="btn-label" value="Summary Table"><br>
        <select class="type-selector" disabled>
            <option value="smart_table" selected>üìã Smart Table</option>
        </select><br>

        <label>Rows: <input type="number" class="rows-input" value="3" min="1" style="width: 60px;" onchange="renderSmartGrid(this)"> </label>
        <label>Columns: <input type="number" class="cols-input" value="5" min="1" style="width: 60px;" onchange="renderSmartGrid(this)"> </label><br>

        <div class="smart-table-grid"></div>

        <label>Database:
            <select class="db-select" onchange="updateTables(this)">
                ${dbOptions}
            </select>
        </label><br>

        <label>Table:
            <select class="table-select">
                <option value="">-- Choose Table --</option>
            </select>
        </label><br>

        <label>Python Code for Selected Cell:<br>
            <textarea class="code-input" placeholder="e.g., df['amount'].sum()" style="width:100%; height:60px;"
              oninput="smartCellCode[selectedSmartCell] = this.value"></textarea>
        </label><br>

        <label>Compare Rules (e.g. R1C1 == R2C2):<br>
            <textarea class="compare-rules-input" placeholder="R1C1 == R2C2\nR3C1 == R1C2" style="width:100%; height:60px;"></textarea>
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto">üì¶ Stack Neatly</option>
                <option value="absolute">üìç Manual Position</option>
            </select>
        </label><br>

        <label>
            <input type="checkbox" class="background-check"> Run in background
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    document.getElementById('workspace').appendChild(div);

    renderSmartGrid(div);
}

        function renderSmartGrid(container) {
    const box = container.closest('.button-box');
    const rows = parseInt(box.querySelector('.rows-input').value);
    const cols = parseInt(box.querySelector('.cols-input').value);

    const gridDiv = box.querySelector('.smart-table-grid');
    let html = `<table border="1" style="margin: 10px 0;">`;

    for (let r = 1; r <= rows; r++) {
        html += `<tr>`;
        for (let c = 1; c <= cols; c++) {
            const cellId = `R${r}C${c}`;
            html += `<td style="padding:10px; cursor:pointer;" data-cell="${cellId}" onclick="selectSmartCell(this, '${cellId}', this.closest('.button-box'))">${cellId}</td>`;
        }
        html += `</tr>`;
    }

    html += `</table>`;
    gridDiv.innerHTML = html;
}

        function selectSmartCell(td, id, box) {
    selectedSmartCell = id;
    const textarea = box.querySelector('.code-input');
    textarea.value = smartCellCode[selectedSmartCell] || "";
}

        function toggleFilterInput(select) {
            const box = select.closest('.button-box');
            const simpleSection = box.querySelector('.simple-filter-section');
            const pythonSection = box.querySelector('.python-filter-section');

            if (select.value === 'python') {
                simpleSection.style.display = 'none';
                pythonSection.style.display = 'block';
            } else {
                simpleSection.style.display = 'block';
                pythonSection.style.display = 'none';
            }
        }

        function updateTablesAndColumns(dbSelect) {
            const box = dbSelect.closest('.button-box');
            const selectedDb = dbSelect.value;
            const tableSelect = box.querySelector('.table-select');
            tableSelect.innerHTML = '';

            if (dbTables[selectedDb]) {
                dbTables[selectedDb].forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    tableSelect.appendChild(option);
                });
            }
        }

        function loadColumnsForTable(tableSelect) {
            const box = tableSelect.closest('.button-box');
            const db = box.querySelector('.db-select').value;
            const table = tableSelect.value;
            const columnListDiv = box.querySelector('.column-list');
            columnListDiv.innerHTML = 'Loading...';

            fetch(`/get_table_columns?db=${encodeURIComponent(db)}&table=${encodeURIComponent(table)}`)
                .then(res => res.json())
                .then(data => {
                    columnListDiv.innerHTML = '';
                    if (data.columns) {
                        data.columns.forEach(col => {
                            const label = document.createElement('label');
                            label.innerHTML = `<input type="checkbox" value="${col}"> ${col}`;
                            columnListDiv.appendChild(label);
                            columnListDiv.appendChild(document.createElement('br'));
                        });
                    } else {
                        columnListDiv.innerHTML = 'No columns found';
                    }
                })
                .catch(err => {
                    console.error("Failed to load columns:", err);
                    columnListDiv.innerHTML = 'Error loading columns';
                });
        }
        
        
        // Build dropdowns
        function buildDatabaseTableDropdowns() {
        return `
            <select class="db-select">
                {% for db in databases %}
                    <option value="{{ db }}">{{ db }}</option>
                {% endfor %}
            </select>
            <select class="table-select">
                {% for db, tables in db_tables.items() %}
                    {% for t in tables %}
                        <option value="{{ t }}">{{ t }}</option>
                    {% endfor %}
                {% endfor %}
            </select>
        `;
        }
            const dbTables = {{ db_tables | tojson }};

        function addButton() {
                addButtonFromData({
                    label: "New Button",
                    type: "code",
                    top: 50,
                    left: 50,
                    config: {
                        code: "",
                        target: "",
                        background: false
                    }
                });
            }

        function addBoxTriggerBox() {
    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = '50px';
    div.style.left = '50px';

    div.innerHTML = `
        <input type="text" class="btn-label" value="Trigger Box"><br>

        <select class="type-selector" disabled>
            <option value="box_trigger" selected>üì¶ Box Trigger</option>
        </select><br>

        <label>Trigger Behavior:
            <select class="trigger-behavior">
                <option value="show_buttons">Show Buttons</option>
                <option value="auto_run">Run Linked Buttons</option>
            </select>
        </label><br>

        <label>Show Buttons:
            <select class="button-alignment">
                <option value="below">Below</option>
                <option value="right">To the Right</option>
            </select>
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto">üì¶ Stack Neatly</option>
                <option value="absolute">üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    document.getElementById('workspace').appendChild(div);
}

        function addUploadBox() {
            const firstDb = Object.keys(dbTables)[0] || "";
            const firstTable = (dbTables[firstDb] || [])[0] || "";
        
        addUploadBoxFromData({
                label: "Upload File",
                type: "upload",
                top: 50,
                left: 50,
                action: "",
                background: false,
                database: firstDb,
                table: firstTable,
                upload_mode: "append"  // ‚úÖ NEW FIELD
            });
        }
        
        function addDownloadBox() {
            const firstDb = Object.keys(dbTables)[0] || "";
            const firstTable = (dbTables[firstDb] || [])[0] || "";
    

        addDownloadBoxFromData({
            label: "Download File",
            type: "download",
            top: 50,
            left: 50,
            action: "",
            background: false,
            database: firstDb,
            table: firstTable,
            file_format: "csv"
        });
        }

        function addMiniAnalytics() {
    const dbOptions = Object.keys(dbTables).map(db => `<option value="${db}">${db}</option>`).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = '50px';
    div.style.left = '50px';
    div.innerHTML = `
        <input type="text" class="btn-label" value="Mini Analytics"><br>

        <select class="type-selector" disabled>
            <option value="mini_analytics" selected>üìä Mini Analytics</option>
        </select><br>

        <label>Database:
            <select class="db-select" onchange="updateTables(this)">
                ${dbOptions}
            </select>
        </label><br>

        <label>Table:
            <select class="table-select">
                <option value="">-- Choose Table --</option>
            </select>
        </label><br>

        <label>Python Code:<br>
            <textarea class="code-input" placeholder="e.g., count = df['id_number'].isna().sum()" style="width:100%; height:60px;"></textarea>
        </label><br>

        <label>
            <input type="checkbox" class="show-chart-check">
            Show Pie Chart
        </label><br>

        <label>Refresh Interval (seconds):
            <input type="number" class="refresh-interval" value="30" min="5" style="width:60px;">
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto">üì¶ Stack Neatly</option>
                <option value="absolute">üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    document.getElementById('workspace').appendChild(div);

}

        function addMultiUploadBox() {
    const dbOptions = Object.keys(dbTables).map(db => `<option value="${db}">${db}</option>`).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = '50px';
    div.style.left = '50px';

    div.innerHTML = `
        <input type="text" class="btn-label" value="Multi Upload"><br>

        <select class="type-selector" disabled>
            <option value="multi_upload" selected>üìö Multi Upload</option>
        </select><br>

        <label>Database:
            <select class="db-select" onchange="updateTables(this)">
                ${dbOptions}
            </select>
        </label><br>

        <label>Table:
            <select class="table-select"><option value="">-- Select Table --</option></select>
        </label><br>

        <label>Python Code:<br>
            <textarea class="code-input" placeholder="Optional Python code..." style="width:100%; height:60px;"></textarea>
        </label><br>

        <label>
            Upload Mode:
            <select class="upload-mode">
                <option value="append">Append</option>
                <option value="replace">Replace</option>
            </select>
        </label>

        <label>
            <input type="checkbox" class="background-check"> Run in background
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto">üì¶ Stack Neatly</option>
                <option value="absolute">üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    document.getElementById('workspace').appendChild(div);

}

        function updateTables(dbSelect) {
            const box = dbSelect.closest('.button-box');
            const selectedDb = dbSelect.value;
            const tableSelect = box.querySelector('.table-select');
            tableSelect.innerHTML = '';
            if (dbTables[selectedDb]) {
                dbTables[selectedDb].forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    tableSelect.appendChild(option);
                });
            }
        }

        // FromData

        function addButtonFromData(data) {
    const config = data.config || {};
    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = (data.top || 0) + 'px';
    div.style.left = (data.left || 0) + 'px';

    const isLink = data.type === 'link';

    div.innerHTML = `
        <input type="text" class="btn-label" value="${data.label || 'New Button'}"><br>

        <select class="type-selector" onchange="toggleActionInput(this)">
            <option value="code" ${!isLink ? 'selected' : ''}>üß† Run Python Code</option>
            <option value="link" ${isLink ? 'selected' : ''}>üîó Link to Page</option>
        </select><br>

        <div class="action-input">
            <select class="page-link" style="${isLink ? '' : 'display:none;'}">
                {% for p in pages %}
                    <option value="{{ p }}" ${config.target === '{{ p }}' ? 'selected' : ''}>{{ p }}</option>
                {% endfor %}
            </select>

            <textarea class="code-input" placeholder="Python code..." style="${isLink ? 'display:none;' : 'display:block'};">${!isLink ? config.code || '' : ''}</textarea>
        </div>

        <label>
            <input type="checkbox" class="background-check" ${config.background ? 'checked' : ''}>
            Run in background
        </label>

        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);
}

        function addUploadBoxFromData(data) {
    const config = data.config || {};

    const db = data.database || config.database || '';
    const table = data.table || config.table || '';
    const uploadMode = data.upload_mode || config.upload_mode || 'append';
    const code = data.action || config.code || '';

    const dbOptions = Object.keys(dbTables).map(dbName =>
        `<option value="${dbName}" ${dbName === db ? 'selected' : ''}>${dbName}</option>`
    ).join('');

    const tableOptions = (dbTables[db] || []).map(tbl =>
        `<option value="${tbl}" ${tbl === table ? 'selected' : ''}>${tbl}</option>`
    ).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = `${data.top}px`;
    div.style.left = `${data.left}px`;

    div.innerHTML = `
        <input type="text" class="btn-label" value="${data.label || 'Upload File'}"><br>
        <select class="type-selector" disabled>
            <option value="upload" selected>üì§ Upload File</option>
        </select><br>

        <textarea class="code-input" placeholder="Optional Python code...">${code}</textarea>

        <label>Database:
            <select class="db-select" name="database" onchange="updateTables(this)">
                ${dbOptions}
            </select>
        </label>

        <label>Table:
            <select class="table-select" name="table">
                ${tableOptions}
            </select>
        </label>

        <label>Upload Mode:
            <select class="upload-mode" name="upload_mode">
                <option value="append" ${uploadMode === 'append' ? 'selected' : ''}>Append to Table</option>
                <option value="replace" ${uploadMode === 'replace' ? 'selected' : ''}>Overwrite Table</option>
            </select>
        </label>

        <input type="file" class="file-input"><br>

        <label><input type="checkbox" class="background-check" ${config.background ? 'checked' : ''}>
            Run in background
        </label>

        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="handleUpload(event)">üì§ Upload</button>
        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);
}

        function addDownloadBoxFromData(data) {
    const config = data.config || {};

    const db = data.database || config.database || '';
    const table = data.table || config.table || '';
    const code = data.action || config.code || '';
    const format = config.file_format || 'csv';

    const dbOptions = Object.keys(dbTables).map(dbName =>
        `<option value="${dbName}" ${dbName === db ? 'selected' : ''}>${dbName}</option>`
    ).join('');

    const tableOptions = (dbTables[db] || []).map(tbl =>
        `<option value="${tbl}" ${tbl === table ? 'selected' : ''}>${tbl}</option>`
    ).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = data.top + 'px';
    div.style.left = data.left + 'px';

    div.innerHTML = `
        <input type="text" class="btn-label" value="${data.label || 'Download File'}"><br>
        <select class="type-selector" disabled><option value="download" selected>üì• Download File</option></select><br>
        <textarea class="code-input" placeholder="Optional Python code...">${code}</textarea>

        <label>Database:
            <select class="db-select" onchange="updateTables(this)">
                ${dbOptions}
            </select>
        </label>

        <label>Table:
            <select class="table-select">
                ${tableOptions}
            </select>
        </label>

        <label>
            <select class="file-format">
                <option value="csv" ${format === 'csv' ? 'selected' : ''}>CSV</option>
                <option value="excel" ${format === 'excel' ? 'selected' : ''}>Excel</option>
            </select> Format
        </label><br>

        <label><input type="checkbox" class="background-check" ${config.background ? 'checked' : ''}>
            Run in background
        </label>

        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);
}

        function addMultiUploadBoxFromData(data) {
    const config = data.config || {};
    const db = config.database || '';
    const table = config.table || '';
    const code = config.code || '';
    const background = config.background ? 'checked' : '';
    const uploadMode = config.upload_mode || 'append';

    const dbOptions = Object.keys(dbTables).map(dbName =>
        `<option value="${dbName}" ${dbName === db ? 'selected' : ''}>${dbName}</option>`
    ).join('');

    const tableOptions = (dbTables[db] || []).map(tbl =>
        `<option value="${tbl}" ${tbl === table ? 'selected' : ''}>${tbl}</option>`
    ).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = `${data.top}px`;
    div.style.left = `${data.left}px`;

    div.innerHTML = `
        <input type="text" class="btn-label" value="${data.label || 'Multi Upload'}"><br>

        <select class="type-selector" disabled>
            <option value="multi_upload" selected>üìö Multi Upload</option>
        </select><br>

        <label>Database:
            <select class="db-select" onchange="updateTables(this)">
                ${dbOptions}
            </select>
        </label><br>

        <label>Table:
            <select class="table-select">
                ${tableOptions}
            </select>
        </label><br>

        <label>Upload Mode:
            <select class="upload-mode">
                <option value="append" ${uploadMode === 'append' ? 'selected' : ''}>Append</option>
                <option value="replace" ${uploadMode === 'replace' ? 'selected' : ''}>Replace</option>
            </select>
        </label><br>

        <label>Python Code:<br>
            <textarea class="code-input" style="width:100%; height:60px;">${code}</textarea>
        </label><br>

        <label>
            <input type="checkbox" class="background-check" ${background}>
            Run in background
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);

    // Reload table list if db changed
    const dbSelect = div.querySelector('.db-select');
    updateTables(dbSelect);
    div.querySelector('.table-select').value = table;
}

        function addAiChatBoxFromData(data) {
    const config = data.config || {};
    const db = data.database || config.database || '';
    const prompt = config.prompt || '';
    const label = data.label || 'AI Chat';
    const background = config.background ? 'checked' : '';

    const dbOptions = Object.keys(dbTables).map(dbName =>
        `<option value="${dbName}" ${dbName === db ? 'selected' : ''}>${dbName}</option>`
    ).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = (data.top || 0) + 'px';
    div.style.left = (data.left || 0) + 'px';

    div.innerHTML = `
        <input type="text" class="btn-label" value="${label}"><br>

        <select class="type-selector" disabled>
            <option value="ai_chat" selected>ü§ñ AI Chat</option>
        </select><br>

        <textarea class="ai-question" placeholder="Example question...">${prompt}</textarea>

        <label>Upload File 1: <input type="file" class="file1-input"></label><br>
        <label>Upload File 2: <input type="file" class="file2-input"></label><br>

        <label>Database:
            <select class="db-select">
                ${dbOptions}
            </select>
        </label><br>

        <label>
            <input type="checkbox" class="background-check" ${background}>
            Run in background
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);
}

        function addFormBoxFromData(data) {
    const config = data.config || {};
    const db = config.database || '';
    const table = config.table || '';
    const keyColumn = config.key_column || 'system_id';
    const filterMode = config.filter_mode || 'simple';
    const sqlFilter = config.sql_filter || '';
    const pythonFilter = config.python_filter || '';
    const editFields = config.edit_fields || [];
    const lookupDb = config.lookup_database || '';
    const lookupTable = config.lookup_table || '';
    const lookupKeyColumn = config.lookup_key_column || '';
    const lookupFields = config.lookup_fields || [];

    const dbOptions = Object.keys(dbTables).map(dbName =>
        `<option value="${dbName}" ${dbName === db ? 'selected' : ''}>${dbName}</option>`
    ).join('');

    const tableOptions = (dbTables[db] || []).map(tbl =>
        `<option value="${tbl}" ${tbl === table ? 'selected' : ''}>${tbl}</option>`
    ).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = (data.top || 0) + 'px';
    div.style.left = (data.left || 0) + 'px';

    div.innerHTML = `
        <input type="text" class="btn-label" value="${data.label || 'Fix Missing Data'}"><br>
        <select class="type-selector" disabled>
            <option value="form" selected>üìù Form</option>
        </select><br>

        <label>Database:
            <select class="db-select" onchange="updateTablesAndColumns(this)">
                ${dbOptions}
            </select>
        </label><br>

        <label>Table:
            <select class="table-select" onchange="loadColumnsForTable(this)">
                ${tableOptions}
            </select>
        </label><br>

        <input type="hidden" class="key-column" value="${keyColumn}">

        <label>Filter Mode:
            <select class="filter-mode" onchange="toggleFilterInput(this)">
                <option value="simple" ${filterMode === 'simple' ? 'selected' : ''}>Simple Filter</option>
                <option value="python" ${filterMode === 'python' ? 'selected' : ''}>Python Code</option>
            </select>
        </label><br>

        <div class="simple-filter-section" style="${filterMode === 'python' ? 'display:none;' : ''}">
            <label>Simple SQL Filter:
                <input type="text" class="sql-filter" value="${sqlFilter}" placeholder="e.g., policy_number IS NULL">
            </label><br>
        </div>

        <div class="python-filter-section" style="${filterMode === 'python' ? 'display:block;' : 'display:none;'}">
            <label>Python Filter Code:<br>
                <textarea class="python-filter-code" style="width:100%; height:60px;">${pythonFilter}</textarea>
            </label><br>
        </div>

        <label>Editable Columns:<br>
            <div class="column-list" style="max-height: 100px; overflow-y: auto; border: 1px solid #ccc;">
                (Loading...)
            </div>
        </label><br>

        <hr>

        <label>üîé Lookup Database:
            <select class="lookup-db-select" onchange="updateLookupTables(this)">
                <option value="">-- None --</option>
                ${dbOptions.replace(`value="${lookupDb}"`, `value="${lookupDb}" selected`)}
            </select>
        </label><br>

        <label>Lookup Table:
            <select class="lookup-table-select" onchange="loadLookupColumns(this)">
                <option value="${lookupTable}" selected>${lookupTable}</option>
            </select>
        </label><br>

        <label>Lookup Key Column:
            <input type="text" class="lookup-key-column" value="${lookupKeyColumn}" placeholder="Optional">
        </label><br>

        <label>Lookup Fields:<br>
            <div class="lookup-column-list" style="max-height: 100px; overflow-y: auto; border: 1px solid #ccc;">
                ${lookupFields.map(field => `<label><input type="checkbox" value="${field}" checked> ${field}</label><br>`).join('')}
            </div>
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);

    // ‚úÖ Fix: force db+table repopulation and column loading
    const dbSelect = div.querySelector('.db-select');
    const tableSelect = div.querySelector('.table-select');
    const columnListDiv = div.querySelector('.column-list');

    dbSelect.value = db;
    updateTablesAndColumns(dbSelect);

    // Load column checkboxes properly with matching saved `editFields`
    tableSelect.value = table;

    fetch(`/get_table_columns?db=${encodeURIComponent(db)}&table=${encodeURIComponent(table)}`)
        .then(res => res.json())
        .then(data => {
            columnListDiv.innerHTML = '';

            if (data.columns) {
                data.columns.forEach(col => {
                    const checked = editFields.includes(col);
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" value="${col}" ${checked ? 'checked' : ''}> ${col}`;
                    columnListDiv.appendChild(label);
                    columnListDiv.appendChild(document.createElement('br'));
                });
            } else {
                columnListDiv.innerHTML = 'No columns found';
            }
        })
        .catch(err => {
            console.error("Failed to load columns:", err);
            columnListDiv.innerHTML = '‚ùå Error loading columns';
        });
}

        function updateLookupTables(select) {
    const box = select.closest('.button-box');
    const lookupDb = select.value;
    const lookupTableSelect = box.querySelector('.lookup-table-select');
    lookupTableSelect.innerHTML = '<option value="">-- Select --</option>';

    if (dbTables[lookupDb]) {
        dbTables[lookupDb].forEach(tbl => {
            const option = document.createElement('option');
            option.value = tbl;
            option.textContent = tbl;
            lookupTableSelect.appendChild(option);
        });
    }
}

        function loadLookupColumns(select) {
    const box = select.closest('.button-box');
    const lookupDb = box.querySelector('.lookup-db-select')?.value || '';
    const lookupTable = select.value || '';
    const lookupColumnList = box.querySelector('.lookup-column-list');

    lookupColumnList.innerHTML = 'Loading...';

    if (!lookupDb || !lookupTable) {
        lookupColumnList.innerHTML = '‚ùå No lookup database or table selected.';
        return;
    }

    fetch(`/get_table_columns?db=${encodeURIComponent(lookupDb)}&table=${encodeURIComponent(lookupTable)}`)
        .then(res => {
            if (!res.ok) throw new Error('Failed to fetch lookup columns');
            return res.json();
        })
        .then(data => {
            lookupColumnList.innerHTML = '';

            if (data.columns && data.columns.length > 0) {
                data.columns.forEach(col => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.innerHTML = `<input type="checkbox" value="${col}"> ${col}`;
                    lookupColumnList.appendChild(label);
                });
            } else {
                lookupColumnList.innerHTML = '‚ùå No columns found.';
            }
        })
        .catch(err => {
            console.error("‚ùå Error loading lookup columns:", err);
            lookupColumnList.innerHTML = '‚ùå Error loading columns';
        });
}
    
        function addMiniAnalyticsFromData(data) {
    const config = data.config || {};
    const db = config.database || '';
    const table = config.table || '';
    const code = config.code || '';
    const refreshInterval = config.refresh_interval || 30;
    const showChart = config.show_chart || false;

    const dbOptions = Object.keys(dbTables).map(dbName =>
        `<option value="${dbName}" ${dbName === db ? 'selected' : ''}>${dbName}</option>`
    ).join('');

    const tableOptions = (dbTables[db] || []).map(tbl =>
        `<option value="${tbl}" ${tbl === table ? 'selected' : ''}>${tbl}</option>`
    ).join('');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = (data.top || 0) + 'px';
    div.style.left = (data.left || 0) + 'px';

    div.innerHTML = `
        <input type="text" class="btn-label" value="${data.label || 'Mini Analytics'}"><br>

        <select class="type-selector" disabled>
            <option value="mini_analytics" selected>üìä Mini Analytics</option>
        </select><br>

        <label>Database:
            <select class="db-select" onchange="updateTables(this)">
                ${dbOptions}
            </select>
        </label><br>

        <label>Table:
            <select class="table-select">
                ${tableOptions}
            </select>
        </label><br>

        <label>Python Code:<br>
            <textarea class="code-input" placeholder="e.g., count = df['id'].isna().sum()" style="width:100%; height:60px;">${code}</textarea>
        </label><br>

        <label>
            <input type="checkbox" class="show-chart-check" ${showChart ? 'checked' : ''}>
            Show Pie Chart
        </label><br>

        <label>Refresh Interval (seconds):
            <input type="number" class="refresh-interval" value="${refreshInterval}" min="5" style="width:60px;">
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);

    // ‚úÖ Ensure correct database -> table loading
    const dbSelect = div.querySelector('.db-select');
    const tableSelect = div.querySelector('.table-select');

    dbSelect.value = db;
    updateTables(dbSelect);

    setTimeout(() => {
        tableSelect.value = table;
    }, 0);
}

        function addSmartTableBoxFromData(data) {
    const config = data.config || {};
    const db = config.database || '';
    const table = config.table || '';
    const rows = config.rows || 1;
    const columns = config.columns || 1;
    const selectedCell = config.selected_cell || 'R1C1';
    smartCellCode = config.cell_code || {};
    selectedSmartCell = selectedCell;

    const dbOptions = Object.keys(dbTables).map(dbName =>
        `<option value="${dbName}" ${dbName === db ? 'selected' : ''}>${dbName}</option>`
    ).join('');

    const tableOptions = (dbTables[db] || []).map(tbl =>
        `<option value="${tbl}" ${tbl === table ? 'selected' : ''}>${tbl}</option>`
    ).join('');

    const compareRuleText = (config.compare_rules || [])
        .map(pair => pair.join(' == '))
        .join('\n');

    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = `${data.top}px`;
    div.style.left = `${data.left}px`;

    div.innerHTML = `
        <input type="text" class="btn-label" value="${data.label || 'Summary Table'}"><br>
        <select class="type-selector" disabled>
            <option value="smart_table" selected>üìã Smart Table</option>
        </select><br>

        <label>Rows: <input type="number" class="rows-input" value="${rows}" min="1" style="width: 60px;" onchange="renderSmartGrid(this)"> </label>
        <label>Columns: <input type="number" class="cols-input" value="${columns}" min="1" style="width: 60px;" onchange="renderSmartGrid(this)"> </label><br>

        <div class="smart-table-grid"></div>

        <label>Database:
            <select class="db-select" onchange="updateTables(this)">
                ${dbOptions}
            </select>
        </label><br>

        <label>Table:
            <select class="table-select">
                ${tableOptions}
            </select>
        </label><br>

        <label>Python Code for Selected Cell:<br>
            <textarea class="code-input" style="width:100%; height:60px;">${smartCellCode[selectedCell] || ''}</textarea>
        </label><br>

        <label>Compare Rules (e.g. R1C1 == R2C2):<br>
            <textarea class="compare-rules-input" style="width:100%; height:60px;">${compareRuleText}</textarea>
        </label><br>

        <label>
            <input type="checkbox" class="background-check" ${config.background ? 'checked' : ''}>
            Run in background
        </label><br>

        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>

        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);
    renderSmartGrid(div);

    const textarea = div.querySelector('.code-input');
    textarea.addEventListener('input', () => {
        smartCellCode[selectedSmartCell] = textarea.value;
    });
}

        function addBoxTriggerBoxFromData(data) {
    const config = data.config || {};
    const div = document.createElement('div');
    div.className = 'button-box';
    div.style.top = (data.top || 0) + 'px';
    div.style.left = (data.left || 0) + 'px';

    div.innerHTML = `
        <input type="text" class="btn-label" value="${data.label || 'Trigger Box'}"><br>

        <select class="type-selector" disabled>
            <option value="box_trigger" selected>üì¶ Box Trigger</option>
        </select><br>

        <label>Trigger Behavior:
            <select class="trigger-behavior">
                <option value="show_buttons" ${config.behavior === 'show_buttons' ? 'selected' : ''}>Show Buttons</option>
                <option value="auto_run" ${config.behavior === 'auto_run' ? 'selected' : ''}>Run Linked</option>
            </select>
        </label><br>

        <label>Show Buttons:
            <select class="button-alignment">
                <option value="below" ${config.alignment === 'below' ? 'selected' : ''}>Below</option>
                <option value="right" ${config.alignment === 'right' ? 'selected' : ''}>To the Right</option>
            </select>
        </label><br>
        
        <label>Group Box:
            <input type="text" class="group-id-input" value="${config.group_id || ''}" placeholder="(optional)">
        </label><br>

        <label>Layout Mode:
            <select class="layout-mode">
                <option value="auto" ${config.layout_mode === 'auto' ? 'selected' : ''}>üì¶ Stack Neatly</option>
                <option value="absolute" ${config.layout_mode === 'absolute' ? 'selected' : ''}>üìç Manual Position</option>
            </select>
        </label><br>


        <button onclick="this.parentElement.remove()">‚ùå</button>
    `;

    appendButtonWithGrouping(div, config);

}

        function appendButtonWithGrouping(div, config) {
    const layoutMode = config.layout_mode || 'auto';
    const groupId = config.group_id || '';
    let parent = document.getElementById('workspace');

    if (groupId && layoutMode === 'auto') {
        let groupDiv = document.querySelector(`.trigger-button-container[data-group="${groupId}"]`);

        if (!groupDiv) {
            groupDiv = document.createElement('div');
            groupDiv.className = 'trigger-button-container below';
            groupDiv.dataset.group = groupId;

            const triggerBox = Array.from(document.querySelectorAll('.button-box'))
                .find(box => box.querySelector('.btn-label')?.value === groupId);

            if (triggerBox) {
                triggerBox.insertAdjacentElement('afterend', groupDiv);
            } else {
                parent.appendChild(groupDiv); // fallback
            }
        }

        parent = groupDiv;
    }

    parent.appendChild(div);
}


        function handleUpload(event) {
    event.preventDefault();

    const box = event.target.closest('.button-box');
    const fileInput = box.querySelector('.file-input');
    const file = fileInput?.files[0];
    const db = box.querySelector('.db-select')?.value;
    const table = box.querySelector('.table-select')?.value;
    const uploadMode = box.querySelector('.upload-mode')?.value || 'append';
    const code = box.querySelector('.code-input')?.value || '';
    const background = box.querySelector('.background-check')?.checked ? 'true' : 'false';

    if (!file) {
        alert("Please select a file.");
        return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('database', db);
    formData.append('table', table);
    formData.append('upload_mode', uploadMode);
    formData.append('code', code);
    formData.append('background', background);

    fetch('/upload_data', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'ok') {
            alert(background === 'true'
                ? "‚úÖ Upload started in background."
                : "‚úÖ File uploaded successfully.");
        } else {
            alert("‚ùå Upload failed: " + data.message);
        }
    })
    .catch(err => {
        console.error("‚ùå Upload error:", err);
        alert("‚ùå Upload error.");
    });
}

        // üíæ Save page layout
        function saveLayout() {
        const boxes = document.querySelectorAll('.button-box');
        const layout = [];
        const workspace = document.getElementById('workspace');

        boxes.forEach(box => {
            const type = box.querySelector('.type-selector')?.value || 'code';
            const label = box.querySelector('.btn-label')?.value || '';

            const config = {};

            switch (type) {
                case 'ai_chat':
                    config.prompt = box.querySelector('.ai-question')?.value || '';
                    config.database = box.querySelector('.db-select')?.value || '';
                    break;

                case 'upload':
                    config.code = box.querySelector('.code-input')?.value || '';
                    config.database = box.querySelector('.db-select')?.value || '';
                    config.table = box.querySelector('.table-select')?.value || '';
                    config.upload_mode = box.querySelector('.upload-mode')?.value || 'append';
                    break;

                case 'download':
                    config.code = box.querySelector('.code-input')?.value || '';
                    config.database = box.querySelector('.db-select')?.value || '';
                    config.table = box.querySelector('.table-select')?.value || '';
                    config.file_format = box.querySelector('.file-format')?.value || 'csv';
                    break;

                case 'form':
                    config.database = box.querySelector('.db-select')?.value || '';
                    config.table = box.querySelector('.table-select')?.value || '';
                    config.key_column = box.querySelector('.key-column')?.value || 'system_id';
                    config.filter_mode = box.querySelector('.filter-mode')?.value || 'simple';
                    config.sql_filter = box.querySelector('.sql-filter')?.value || '';
                    config.python_filter = box.querySelector('.python-filter-code')?.value || '';
                    config.edit_fields = Array.from(box.querySelectorAll('.column-list input:checked')).map(input => input.value);
                    config.lookup_database = box.querySelector('.lookup-db-select')?.value || '';
                    config.lookup_table = box.querySelector('.lookup-table-select')?.value || '';
                    config.lookup_key_column = box.querySelector('.lookup-key-column')?.value || '';
                    config.lookup_fields = Array.from(box.querySelectorAll('.lookup-column-list input:checked')).map(input => input.value);
                    break;

                case 'mini_analytics':
                    config.database = box.querySelector('.db-select')?.value || '';
                    config.table = box.querySelector('.table-select')?.value || '';
                    config.code = box.querySelector('.code-input')?.value || '';
                    config.refresh_interval = parseInt(box.querySelector('.refresh-interval')?.value || '30');
                    config.show_chart = box.querySelector('.show-chart-check')?.checked || false;
                    break;
                
                case 'smart_table':
                    config.rows = parseInt(box.querySelector('.rows-input')?.value || '1');
                    config.columns = parseInt(box.querySelector('.cols-input')?.value || '1');
                    config.database = box.querySelector('.db-select')?.value || '';
                    config.table = box.querySelector('.table-select')?.value || '';
                    config.selected_cell = selectedSmartCell;
                    config.cell_code = smartCellCode;
                    config.background = box.querySelector('.background-check')?.checked || false;
                    const rawRules = box.querySelector('.compare-rules-input')?.value || '';
                    config.compare_rules = rawRules.split('\n')
                    .map(line => line.trim().split('==').map(part => part.trim())).filter(pair => pair.length === 2);
                    break;

                case 'multi_upload':
                    config.database = box.querySelector('.db-select')?.value || '';
                    config.table = box.querySelector('.table-select')?.value || '';
                    config.code = box.querySelector('.code-input')?.value || '';
                    config.upload_mode = box.querySelector('.upload-mode')?.value || 'append';
                    break;

                case 'box_trigger':
                    config.behavior = box.querySelector('.trigger-behavior')?.value || 'show_buttons';
                    config.alignment = box.querySelector('.button-alignment')?.value || 'below';
                    break;


                case 'link':
                    config.target = box.querySelector('.page-link')?.value || '';
                    break;

                case 'code':
                    config.code = box.querySelector('.code-input')?.value || '';
                    break;

                default:
                    console.warn("Unknown button type:", type);
            }
            // ‚úÖ Add group_id to all configs if present
            config.group_id = box.querySelector('.group-id-input')?.value || '';
            config.layout_mode = box.querySelector('.layout-mode')?.value || 'auto';
            config.background = box.querySelector('.background-check')?.checked || false;

            const layoutItem = {
                type,
                label,
                version: 1,
                config
            };

            // Only include position for absolute layout
            layoutItem.top = parseInt(box.style.top) || 0;
            layoutItem.left = parseInt(box.style.left) || 0;

            layout.push(layoutItem);

        });

        const workspaceHeight = workspace.offsetHeight;

        fetch("{{ url_for('edit_page.save_page', page_name=page_name) }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ layout, workspace_height: workspaceHeight })
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed to save');
            return res.json();
        })
        .then(() => alert("‚úÖ Layout saved!"))
        .catch(err => {
            console.error("Save failed:", err);
            alert("‚ùå Save failed.");
        });
    } 
    



        // ‚úÖ loading layout and workspace height
        {% if workspace_height %}
            document.getElementById('workspace').style.minHeight = '{{ workspace_height }}px';
        {% endif %}

        {% for item in layout %}
            {% if item.type == 'upload' %}
        addUploadBoxFromData({{ item | tojson }});
            {% elif item.type == 'download' %}
        addDownloadBoxFromData({{ item | tojson }});
            {% elif item.type == 'multi_upload' %}
        addMultiUploadBoxFromData({{ item | tojson }});
            {% elif item.type == 'ai_chat' %}
        addAiChatBoxFromData({{ item | tojson }});
            {% elif item.type == 'form' %}
        addFormBoxFromData({{ item | tojson }});
            {% elif item.type == 'mini_analytics' %}
        addMiniAnalyticsFromData({{ item | tojson }});
            {% elif item.type == 'box_trigger' %}
        addBoxTriggerBoxFromData({{ item | tojson }});
            {% elif item.type == 'smart_table' %}
        addSmartTableBoxFromData({{ item | tojson }});
            {% else %}
        addButtonFromData({{ item | tojson }});
            {% endif %}
        {% endfor %}


    </script>
    
</body>
</html>
